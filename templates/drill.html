{% extends "base.html" %}

{% block title %}
  {% if mode == 'letters' %}Vowel Drills
  {% elif mode == 'words' %}Word Reading
  {% elif mode == 'phrases' %}Phrase Flow
  {% elif mode == 'prayer' %}Prayer Simulation
  {% elif mode == 'consonants' %}Rapid-Fire Consonants
  {% elif mode == 'vowelfire' %}Rapid-Fire Vowels
  {% elif mode == 'siddur' %}Siddur Reading
  {% endif %} â€” Hebrew Trainer
{% endblock %}

{% block content %}
<div class="space-y-5">

  <!-- Header -->
  <div class="flex items-center gap-3">
    <a href="/" class="text-gray-600 hover:text-gray-300 transition-colors shrink-0">â€¹</a>
    <h1 class="text-xl font-semibold text-gray-100 flex-1 text-center">
      {% if mode == 'letters' %}Vowel Drills
      {% elif mode == 'words' %}Word Reading
      {% elif mode == 'phrases' %}Phrase Flow
      {% elif mode == 'prayer' %}Prayer Simulation
      {% elif mode == 'consonants' %}Rapid-Fire Consonants
      {% elif mode == 'vowelfire' %}Rapid-Fire Vowels
      {% elif mode == 'siddur' %}Siddur Reading
      {% endif %}
    </h1>
    <!-- spacer to balance the back arrow and keep title visually centred -->
    <span class="w-4 shrink-0"></span>
  </div>

  <!-- Timer card -->
  <div class="bg-gray-900 rounded-2xl border border-gray-800 p-6">
    <div id="timer-display"
         class="timer-display text-6xl font-mono font-bold text-center text-gray-100 mb-4 tracking-widest">
      00:00
    </div>

    <!-- Target time progress -->
    <div id="target-row" class="mb-6 px-2">
      <div class="flex items-center justify-between text-xs mb-1.5">
        <span class="text-gray-600 uppercase tracking-wide">Target</span>
        <span id="target-label" class="font-medium tabular-nums text-gray-500">
          {% if target_satisfied %}âœ“ Target reached{% else %}{{ target_minutes }} min remaining{% endif %}
        </span>
      </div>
      <div class="bg-gray-800 rounded-full h-1.5 overflow-hidden">
        <div id="target-bar"
             class="h-1.5 rounded-full transition-all duration-500
             {% if mode == 'consonants' %}bg-rose-500
             {% elif mode == 'letters' %}bg-indigo-500
             {% elif mode == 'vowelfire' %}bg-purple-500
             {% elif mode == 'words' %}bg-violet-500
             {% elif mode == 'phrases' %}bg-sky-500
             {% elif mode == 'siddur' %}bg-teal-500
             {% else %}bg-amber-500{% endif %}"
             style="width: 0%">
        </div>
      </div>
    </div>

    <div class="flex flex-wrap gap-3 justify-center">
      <button id="start-btn"
              class="px-7 py-2.5 bg-indigo-600 hover:bg-indigo-500 active:bg-indigo-700
                     text-white font-medium rounded-xl transition-colors">
        Start
      </button>
      <button id="pause-btn"
              class="hidden px-7 py-2.5 bg-gray-700 hover:bg-gray-600
                     text-white font-medium rounded-xl transition-colors">
        Pause
      </button>
      <button id="record-btn"
              class="px-5 py-2.5 bg-gray-800 hover:bg-gray-700 border border-gray-700
                     text-gray-400 text-sm font-medium rounded-xl transition-colors"
              title="Record this session">
        &#127908; Record
      </button>
      <button id="speak-btn"
              class="px-5 py-2.5 bg-gray-800 hover:bg-gray-700 border border-gray-700
                     text-gray-400 text-sm font-medium rounded-xl transition-colors hidden"
              title="Read aloud">
        &#128266;
      </button>
      <button id="complete-btn"
              class="px-7 py-2.5 bg-emerald-700 hover:bg-emerald-600 active:bg-emerald-800
                     disabled:opacity-35 disabled:cursor-not-allowed
                     text-white font-medium rounded-xl transition-colors"
              disabled>
        Complete
      </button>
    </div>

    <!-- Recording indicator -->
    <div id="recording-indicator" class="hidden flex items-center justify-center gap-2 mt-3">
      <span class="inline-block w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse"></span>
      <span class="text-xs text-red-400 font-medium">Recording in progress</span>
    </div>

    <p id="session-status"
       class="hidden mt-4 text-center text-emerald-400 text-sm font-medium"></p>
  </div>

  {% if mode == 'siddur' %}
  <!-- Siddur: timer-only instructions -->
  <div class="bg-gray-900 rounded-2xl border border-gray-800 p-6 space-y-5">
    <div class="text-center">
      <div class="text-6xl mb-4">ðŸ“–</div>
      <h2 class="text-xl font-semibold text-gray-100">Open Your Siddur</h2>
      <p class="text-gray-500 text-sm mt-2">Eyes and mouth. Keep moving.</p>
    </div>
    <div class="space-y-2 text-sm">
      <div class="bg-gray-800/60 rounded-xl px-4 py-3 flex items-start gap-3">
        <span class="text-teal-400 font-bold shrink-0">1.</span>
        <span class="text-gray-300">Open to your practice passage â€” Shema, Ashrei, Amidah, or wherever you are in the plan.</span>
      </div>
      <div class="bg-gray-800/60 rounded-xl px-4 py-3 flex items-start gap-3">
        <span class="text-teal-400 font-bold shrink-0">2.</span>
        <span class="text-gray-300">Press <strong class="text-gray-100">Start</strong> then read aloud continuously â€” no pausing to translate.</span>
      </div>
      <div class="bg-gray-800/60 rounded-xl px-4 py-3 flex items-start gap-3">
        <span class="text-teal-400 font-bold shrink-0">3.</span>
        <span class="text-gray-300">Push through hesitations. Flow over perfection â€” keep rhythm.</span>
      </div>
      <div class="bg-gray-800/60 rounded-xl px-4 py-3 flex items-start gap-3">
        <span class="text-teal-400 font-bold shrink-0">4.</span>
        <span class="text-gray-300">When done, press <strong class="text-gray-100">Complete Session</strong> to log your time.</span>
      </div>
    </div>
    <p class="text-xs text-gray-600 text-center italic border-t border-gray-800 pt-4">
      ðŸ’¡ Aim for at least 5 minutes of continuous reading per session.
    </p>
  </div>

  <!-- Siddur hint -->
  <p class="text-center text-xs text-gray-700">
    Open your siddur. Press <span class="text-gray-500">Start</span>, read continuously,
    then <span class="text-gray-500">Complete</span> to save.
  </p>

  {% else %}
  <!-- Drill content card -->
  <div class="bg-gray-900 rounded-2xl border border-gray-800 overflow-hidden">

    {% if mode in ['consonants', 'vowelfire', 'letters', 'words', 'phrases', 'prayer'] %}
    <div class="flex flex-wrap items-center justify-center gap-4 px-4 py-3 border-b border-gray-800 bg-gray-950/40">
      <button id="auto-play-btn"
              class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 border border-gray-700
                     text-gray-400 text-sm rounded-lg transition-colors"
              title="Auto-play random items">
        â–¶ Auto Play
      </button>
      <div class="flex items-center gap-2 text-xs text-gray-500">
        <span>Interval</span>
        <input id="auto-play-slider" type="range"
               min="{% if mode in ['letters', 'words'] %}1{% elif mode in ['phrases', 'prayer'] %}3{% else %}0.5{% endif %}"
               max="{% if mode == 'letters' %}7{% elif mode == 'words' %}5{% elif mode in ['phrases', 'prayer'] %}15{% else %}1.5{% endif %}"
               step="{% if mode in ['letters', 'words'] %}0.5{% elif mode in ['phrases', 'prayer'] %}1{% else %}0.1{% endif %}"
               value="{{ saved_interval }}"
               class="{% if mode == 'vowelfire' %}accent-purple-500{% elif mode == 'letters' %}accent-indigo-500{% elif mode == 'words' %}accent-violet-500{% else %}accent-rose-500{% endif %} w-40">
        <span id="auto-play-value" class="text-gray-300 tabular-nums">{{ saved_interval }}s</span>
      </div>
    </div>
    {% endif %}

    <!-- Items container -->
    <div id="drill-items-container" class="drill-content">
      {% for item in content %}
      <div class="drill-item hidden" data-original="{{ item }}">
        {% if mode in ['consonants', 'letters', 'vowelfire'] %}
        <div class="hebrew-baseline-wrap py-10 px-6 min-h-52">
          <div class="hebrew-baseline-inner">
            <div class="hebrew-text font-hebrew text-center text-gray-100
                        {% if mode in ['consonants', 'vowelfire'] %}text-8xl sm:text-9xl{% else %}text-5xl sm:text-6xl{% endif %}">
              {{ item }}
            </div>
            {% if mode == 'consonants' %}<div class="baseline-rule-line"></div>{% endif %}
          </div>
        </div>
        {% else %}
        <div class="hebrew-text font-hebrew
                    text-center text-gray-100 py-10 px-6
                    min-h-52 flex items-center justify-center
                    text-5xl sm:text-6xl">
          {{ item }}
        </div>
        {% endif %}
      </div>
      {% else %}
      <div class="text-center py-16 text-gray-600 text-sm">
        No content available for this drill mode.
      </div>
      {% endfor %}
    </div>

    <!-- Transliteration box (shows previous item's answer) -->
    <div id="translit-box" class="hidden border-t border-gray-800 bg-gray-950/40 px-6 py-3 text-center">
      <p class="text-xs text-gray-600 uppercase tracking-widest mb-2">Previous item</p>
      <p class="flex items-center justify-center gap-2 flex-wrap">
        <span id="translit-prev-hebrew" class="font-hebrew text-2xl text-gray-400" dir="rtl"></span>
        <span class="text-gray-700">&mdash;</span>
        <span id="translit-text" class="text-sm text-gray-500 tracking-wide"
              dir="ltr" style="font-style: italic;"></span>
      </p>
    </div>

  </div>

  <!-- Reference guide card -->
  {% if mode in ['letters', 'consonants'] %}
  <div class="bg-gray-900 rounded-2xl border border-gray-800 overflow-hidden">
    <div class="flex items-center justify-between px-4 py-3">
      <p class="text-xs text-gray-500 uppercase tracking-widest font-medium">
        {% if mode == 'letters' %}Vowel{% else %}Consonant{% endif %} Reference
      </p>
      <button id="vowel-guide-btn"
              class="px-3 py-1.5 bg-gray-800 hover:bg-gray-700 border border-gray-700
                     text-gray-400 text-sm rounded-lg transition-colors"
              title="Toggle quick reference">
        ðŸ“‹ Guide
      </button>
    </div>
    <div id="vowel-guide-panel" class="hidden border-t border-gray-800 p-4">
      {% if mode == 'letters' %}
      <div class="grid grid-cols-4 sm:grid-cols-6 gap-2" dir="ltr">
        {% for symbol, name, sound, heb_example, eng_example in vowels %}
        <div class="bg-gray-800 rounded-lg p-2 text-center">
          <div class="text-3xl font-hebrew text-indigo-300 leading-tight mb-1">{{ symbol }}</div>
          <div class="text-xs text-gray-300 font-medium leading-tight">{{ sound }}</div>
          <div class="text-xs text-gray-600 leading-tight italic">{{ eng_example }}</div>
        </div>
        {% endfor %}
      </div>
      {% elif mode == 'consonants' %}
      <div class="grid grid-cols-4 sm:grid-cols-6 gap-2" dir="ltr">
        {% for letter, name, sound, example in consonants %}
        <div class="bg-gray-800 rounded-lg p-2 text-center">
          <div class="text-3xl font-hebrew text-rose-300 leading-tight mb-1">{{ letter }}</div>
          <div class="text-xs text-gray-300 font-medium leading-tight">{{ name }}</div>
          <div class="text-xs text-gray-600 leading-tight">{{ sound }}</div>
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <!-- Hint â€” dir=ltr on root so no bidi workaround needed -->
  <p class="text-center text-xs text-gray-700">
    Press <span class="text-gray-500">Start</span> when ready.
    Tap the card to advance, then <span class="text-gray-500">Complete</span> to save.
    {% if mode == 'letters' %}<br class="mt-1">
    <span class="text-gray-600">Vowels shuffle randomly each item.</span>
    {% endif %}
  </p>
  {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', () => {
    initDrill('{{ mode }}', {{ target_minutes }}, {{ target_satisfied | tojson }});
  });
</script>
{% endblock %}
