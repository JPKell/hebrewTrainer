{% extends "base.html" %}

{% block title %}Sessions ‚Äî Hebrew Trainer{% endblock %}

{% block content %}
<div class="space-y-6" dir="ltr">

  <!-- Header -->
  <div class="flex items-start justify-between gap-3">
    <div>
      <h1 class="text-2xl font-bold text-gray-100">Sessions</h1>
      <p class="text-gray-500 text-sm mt-1">Practice history ¬∑ manage recordings</p>
    </div>
    {% if mode_filter != 'all' and sessions %}
        <form method="POST" action="/sessions/delete_mode/{{ mode_filter }}"
          onsubmit="return confirm('Delete ALL {{ 'vowels' if mode_filter == 'letters' else mode_filter }} sessions and recordings? This cannot be undone.')">
      <button type="submit"
              class="text-xs px-3 py-1.5 bg-red-900/40 text-red-400 hover:bg-red-800/60
                     border border-red-800/60 rounded-xl transition-colors mt-1">
        Clear all {{ 'vowels' if mode_filter == 'letters' else mode_filter }}
      </button>
    </form>
    {% endif %}
  </div>

  <!-- Mode filter tabs -->
  <div class="flex flex-wrap gap-2">
    <a href="/sessions"
       class="text-sm px-3 py-1.5 rounded-xl font-medium transition-colors
              {% if mode_filter == 'all' %}bg-gray-700 text-gray-100{% else %}bg-gray-900 text-gray-500 hover:text-gray-300 border border-gray-800{% endif %}">
      All
    </a>
    {% for mode in modes %}
    <a href="/sessions?mode={{ mode }}"
       class="text-sm px-3 py-1.5 rounded-xl font-medium transition-colors
              {% if mode_filter == mode %}
                {% if mode == 'consonants' %}bg-rose-700 text-white
                {% elif mode == 'letters' %}bg-indigo-700 text-white
                {% elif mode == 'vowelfire' %}bg-purple-700 text-white
                {% elif mode == 'words' %}bg-violet-700 text-white
                {% elif mode == 'phrases' %}bg-sky-700 text-white
                {% elif mode == 'prayer' %}bg-amber-700 text-white
                {% elif mode == 'siddur' %}bg-teal-700 text-white
                {% else %}bg-gray-700 text-white{% endif %}
              {% else %}bg-gray-900 text-gray-500 hover:text-gray-300 border border-gray-800{% endif %}">
      {{ 'Vowels' if mode == 'letters' else ('Vowel Fire' if mode == 'vowelfire' else mode | capitalize) }}
    </a>
    {% endfor %}
  </div>

  <!-- Session list -->
  {% if sessions %}
  <div class="bg-gray-900 rounded-2xl border border-gray-800 overflow-hidden divide-y divide-gray-800">
    {% for session in sessions %}

    <!-- Session row -->
    <div class="flex items-center gap-3 px-4 py-3.5">
      <!-- Mode dot -->
      <span class="w-2.5 h-2.5 rounded-full shrink-0
        {% if session.mode == 'consonants' %}bg-rose-500
        {% elif session.mode == 'letters' %}bg-indigo-500
        {% elif session.mode == 'vowelfire' %}bg-purple-500
        {% elif session.mode == 'words' %}bg-violet-500
        {% elif session.mode == 'phrases' %}bg-sky-500
        {% elif session.mode == 'siddur' %}bg-teal-500
        {% else %}bg-amber-500{% endif %}"></span>

      <!-- Mode + date -->
      <div class="flex-1 min-w-0">
        <div class="text-sm text-gray-200 font-medium capitalize">{{ 'vowels' if session.mode == 'letters' else ('vowel fire' if session.mode == 'vowelfire' else session.mode) }}</div>
        <div class="text-xs text-gray-600">{{ session.date.strftime('%b %-d, %Y') }}</div>
      </div>

      <!-- Duration -->
      <div class="text-sm text-gray-400 tabular-nums shrink-0">{{ session.duration_seconds | fmt_duration }}</div>

      <!-- Play recording button -->
      {% if session.recording_path %}
      <button onclick="togglePlayer({{ session.id }})"
              id="play-btn-{{ session.id }}"
              class="px-2.5 py-1 bg-gray-800 hover:bg-gray-700 text-gray-400 hover:text-gray-200
                     text-xs rounded-lg transition-colors shrink-0"
              title="Play / hide recording">
        üéµ
      </button>
      {% endif %}

      <!-- Delete button -->
      <form method="POST" action="/sessions/{{ session.id }}/delete"
            onsubmit="return confirm('Delete this session?')">
        <button type="submit"
                class="px-2.5 py-1 bg-gray-800 hover:bg-red-900/60 text-gray-600 hover:text-red-400
                       text-xs rounded-lg transition-colors shrink-0"
                title="Delete session">
          üóë
        </button>
      </form>
    </div>

    <!-- Inline audio player (hidden until toggled) -->
    {% if session.recording_path %}
    <div id="player-{{ session.id }}" class="hidden px-4 pb-3 pt-1 bg-gray-900/60">
      <audio id="audio-{{ session.id }}"
             controls
             class="w-full rounded-lg"
             src="{{ url_for('static', filename=session.recording_path) }}">
      </audio>
    </div>
    {% endif %}

    {% endfor %}
  </div>

  <!-- Summary -->
  <p class="text-xs text-gray-700 text-center">
    {{ sessions | length }} session{{ 's' if sessions | length != 1 else '' }}
    ¬∑ {{ sessions | sum(attribute='duration_seconds') | fmt_duration }} total
    <span class="text-gray-800 mx-1">¬∑</span>
    {{ sessions | selectattr('recording_path') | list | length }} recording{{ 's' if (sessions | selectattr('recording_path') | list | length) != 1 else '' }}
  </p>

  {% else %}
  <!-- Empty state -->
  <div class="text-center py-16 text-gray-600">
    <div class="text-5xl mb-4">üì≠</div>
    <div class="text-sm">No sessions yet{% if mode_filter != 'all' %} for {{ 'vowels' if mode_filter == 'letters' else mode_filter }}{% endif %}</div>
    <a href="/" class="text-sm text-indigo-500 hover:text-indigo-400 transition-colors mt-3 inline-block">
      Start your first session ‚Üí
    </a>
  </div>
  {% endif %}

  <!-- Note about stats -->
  <p class="text-xs text-center text-gray-700 italic pb-2">
    Deleting a session adjusts your total minutes but not your streak history.
  </p>

</div>
{% endblock %}

{% block scripts %}
<script>
function togglePlayer(sessionId) {
  const player = document.getElementById('player-' + sessionId);
  const audio  = document.getElementById('audio-' + sessionId);
  const btn    = document.getElementById('play-btn-' + sessionId);
  if (!player) return;

  if (player.classList.contains('hidden')) {
    player.classList.remove('hidden');
    if (audio) audio.play();
    if (btn) btn.textContent = '‚èπ';
  } else {
    player.classList.add('hidden');
    if (audio) { audio.pause(); audio.currentTime = 0; }
    if (btn) btn.textContent = 'üéµ';
  }
}
</script>
{% endblock %}
