{% extends "base.html" %}

{% block title %}Admin â€” Hebrew Trainer{% endblock %}

{% block content %}
<div class="space-y-8" dir="ltr">

  <!-- Header -->
  <div>
    <h1 class="text-2xl font-bold text-gray-100">Admin</h1>
    <p class="text-gray-500 text-sm mt-1">Settings &amp; database editor</p>
  </div>

  <!-- â”€â”€ Stats Editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="bg-gray-900 rounded-2xl border border-gray-800 p-6 space-y-6">
    <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-widest">Stats</h2>

    {% for row in users_stats %}
    <div class="{% if not loop.first %}border-t border-gray-800 pt-5{% endif %} space-y-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <span class="text-xs text-gray-600">#{{ row.user.id }}</span>
          <span class="text-sm font-medium text-gray-300">{{ row.user.username }}</span>
        </div>
        <form method="POST" action="/admin/stats/reset"
              onsubmit="return confirm('Reset stats for {{ row.user.username }}?')">
          <input type="hidden" name="user_id" value="{{ row.user.id }}">
          <button type="submit"
                  class="text-xs px-3 py-1.5 bg-red-900/40 text-red-400 hover:bg-red-800/60
                         border border-red-800/60 rounded-xl transition-colors">
            Reset
          </button>
        </form>
      </div>
      <form method="POST" action="/admin/stats/edit" class="space-y-3">
        <input type="hidden" name="user_id" value="{{ row.user.id }}">
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
          <div class="space-y-1">
            <label class="text-xs text-gray-500">Current Streak</label>
            <input type="number" name="current_streak" min="0"
                   value="{{ row.stats.current_streak }}"
                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2
                          text-gray-100 text-sm focus:outline-none focus:border-indigo-500">
          </div>
          <div class="space-y-1">
            <label class="text-xs text-gray-500">Longest Streak</label>
            <input type="number" name="longest_streak" min="0"
                   value="{{ row.stats.longest_streak }}"
                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2
                          text-gray-100 text-sm focus:outline-none focus:border-indigo-500">
          </div>
          <div class="space-y-1">
            <label class="text-xs text-gray-500">Total Minutes</label>
            <input type="number" name="total_minutes" min="0"
                   value="{{ row.stats.total_minutes }}"
                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2
                          text-gray-100 text-sm focus:outline-none focus:border-indigo-500">
          </div>
          <div class="space-y-1">
            <label class="text-xs text-gray-500">Last Practice Date</label>
            <input type="date" name="last_practice_date"
                   value="{{ row.stats.last_practice_date.isoformat() if row.stats.last_practice_date else '' }}"
                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-3 py-2
                          text-gray-100 text-sm focus:outline-none focus:border-indigo-500">
          </div>
        </div>
        <button type="submit"
                class="px-5 py-2 bg-indigo-700 hover:bg-indigo-600 text-white text-sm
                       font-medium rounded-xl transition-colors">
          Save
        </button>
      </form>
    </div>
    {% else %}
    <p class="text-sm text-gray-600">No users found.</p>
    {% endfor %}
  </div>

  <!-- â”€â”€ Session Editor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="bg-gray-900 rounded-2xl border border-gray-800 overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-800 flex items-center justify-between">
      <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-widest">
        Sessions
        <span class="ml-2 text-gray-600 normal-case font-normal">({{ sessions | length }} records)</span>
      </h2>
      <!-- Filter -->
      <div class="flex flex-wrap gap-1.5" id="mode-filter-btns">
        <button onclick="filterSessions('all')"
                class="filter-btn text-xs px-2.5 py-1 rounded-lg bg-gray-700 text-gray-100 transition-colors"
                data-mode="all">All</button>
        {% for mode in modes %}
        <button onclick="filterSessions('{{ mode }}')"
          class="filter-btn text-xs px-2.5 py-1 rounded-lg bg-gray-800 text-gray-500
                 hover:text-gray-300 transition-colors"
          data-mode="{{ mode }}">{{ 'Vowels' if mode == 'letters' else mode | capitalize }}</button>
        {% endfor %}
      </div>
    </div>

    <!-- Table header -->
    <div class="hidden sm:grid grid-cols-12 gap-2 px-4 py-2 text-xs text-gray-600 uppercase tracking-wider border-b border-gray-800">
      <div class="col-span-1">ID</div>
      <div class="col-span-1">User</div>
      <div class="col-span-2">Date</div>
      <div class="col-span-3">Mode</div>
      <div class="col-span-1">Mins</div>
      <div class="col-span-1">Rec</div>
      <div class="col-span-3 text-right">Actions</div>
    </div>

    <!-- Session rows -->
    <div id="session-rows" class="divide-y divide-gray-800/60 max-h-[60vh] overflow-y-auto">
      {% for s in sessions %}
      <div class="session-row px-4 py-3" data-mode="{{ s.mode }}" id="row-{{ s.id }}">

        <!-- View mode -->
        <div class="view-state grid grid-cols-12 gap-2 items-center">
          <div class="col-span-1 text-xs text-gray-600">#{{ s.id }}</div>
          <div class="col-span-1 text-xs text-gray-500" title="user_id">{{ s.user_id or 'â€”' }}</div>
          <div class="col-span-2 text-sm text-gray-400">{{ s.date.strftime('%Y-%m-%d') }}</div>
          <div class="col-span-3">
            <span class="text-xs px-2 py-0.5 rounded-full
              {% if s.mode == 'consonants' %}bg-rose-900/60 text-rose-400
              {% elif s.mode == 'letters' %}bg-indigo-900/60 text-indigo-400
              {% elif s.mode == 'vowelfire' %}bg-purple-900/60 text-purple-400
              {% elif s.mode == 'words' %}bg-violet-900/60 text-violet-400
              {% elif s.mode == 'phrases' %}bg-sky-900/60 text-sky-400
              {% elif s.mode == 'prayer' %}bg-amber-900/60 text-amber-400
              {% elif s.mode == 'siddur' %}bg-teal-900/60 text-teal-400
              {% else %}bg-gray-800 text-gray-400{% endif %}">
              {{ 'vowels' if s.mode == 'letters' else ('vowel fire' if s.mode == 'vowelfire' else s.mode) }}
            </span>
          </div>
          <div class="col-span-1 text-sm text-gray-300">{{ s.minutes }}m</div>
          <div class="col-span-1 text-center" title="{{ s.recording_path or 'no recording' }}">{% if s.recording_path %}<span class="text-xs">ðŸŽ™</span>{% endif %}</div>
          <div class="col-span-3 flex justify-end gap-2">
            <button onclick="startEdit({{ s.id }})"
                    class="text-xs px-2.5 py-1 bg-gray-800 hover:bg-gray-700 text-gray-400
                           hover:text-gray-200 rounded-lg transition-colors border border-gray-700">
              Edit
            </button>
            <form method="POST" action="/admin/session/{{ s.id }}/delete"
                  onsubmit="return confirm('Delete session #{{ s.id }}?')" class="inline">
              <button type="submit"
                      class="text-xs px-2.5 py-1 bg-red-900/40 hover:bg-red-800/60 text-red-400
                             rounded-lg transition-colors border border-red-800/60">
                Del
              </button>
            </form>
          </div>
        </div>

        <!-- Edit mode (hidden by default) -->
        <form method="POST" action="/admin/session/{{ s.id }}/edit"
              class="edit-state hidden space-y-2 pt-1">
          <div class="grid grid-cols-12 gap-2 items-end">
            <div class="col-span-1 text-xs text-gray-600 pb-2">#{{ s.id }}</div>
            <div class="col-span-1">
              <label class="text-xs text-gray-600">User</label>
              <input type="number" name="user_id" min="1" value="{{ s.user_id or '' }}"
                     class="w-full bg-gray-800 border border-gray-700 rounded-lg px-2 py-1.5
                            text-gray-100 text-xs focus:outline-none focus:border-indigo-500">
            </div>
            <div class="col-span-2">
              <label class="text-xs text-gray-600">Date</label>
              <input type="date" name="date" value="{{ s.date.isoformat() }}"
                     class="w-full bg-gray-800 border border-gray-700 rounded-lg px-2 py-1.5
                            text-gray-100 text-xs focus:outline-none focus:border-indigo-500">
            </div>
            <div class="col-span-3">
              <label class="text-xs text-gray-600">Mode</label>
              <select name="mode"
                      class="w-full bg-gray-800 border border-gray-700 rounded-lg px-2 py-1.5
                             text-gray-100 text-xs focus:outline-none focus:border-indigo-500">
                {% for mode in modes %}
                <option value="{{ mode }}" {% if s.mode == mode %}selected{% endif %}>{{ 'vowels' if mode == 'letters' else ('vowel fire' if mode == 'vowelfire' else mode) }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-span-1">
              <label class="text-xs text-gray-600">Mins</label>
              <input type="number" name="minutes" min="1" value="{{ s.minutes }}"
                     class="w-full bg-gray-800 border border-gray-700 rounded-lg px-2 py-1.5
                            text-gray-100 text-xs focus:outline-none focus:border-indigo-500">
            </div>
            <div class="col-span-1"></div>
            <div class="col-span-3 flex justify-end gap-2 pb-0.5">
              <button type="submit"
                      class="text-xs px-2.5 py-1.5 bg-emerald-700 hover:bg-emerald-600 text-white
                             rounded-lg transition-colors">
                Save
              </button>
              <button type="button" onclick="cancelEdit({{ s.id }})"
                      class="text-xs px-2.5 py-1.5 bg-gray-800 hover:bg-gray-700 text-gray-400
                             rounded-lg transition-colors border border-gray-700">
                Cancel
              </button>
            </div>
          </div>
          <div>
            <label class="text-xs text-gray-600">Recording Path</label>
            <input type="text" name="recording_path" value="{{ s.recording_path or '' }}"
                   placeholder="recordings/session_X.webm"
                   class="w-full bg-gray-800 border border-gray-700 rounded-lg px-2 py-1.5
                          text-gray-100 text-xs focus:outline-none focus:border-indigo-500">
          </div>
        </form>

      </div>
      {% else %}
      <div class="px-6 py-10 text-center text-gray-600 text-sm">No sessions recorded yet.</div>
      {% endfor %}
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
// â”€â”€ Session inline edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startEdit(id) {
  document.querySelector(`#row-${id} .view-state`).classList.add('hidden');
  document.querySelector(`#row-${id} .edit-state`).classList.remove('hidden');
}
function cancelEdit(id) {
  document.querySelector(`#row-${id} .edit-state`).classList.add('hidden');
  document.querySelector(`#row-${id} .view-state`).classList.remove('hidden');
}

// â”€â”€ Mode filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterSessions(mode) {
  document.querySelectorAll('.session-row').forEach(row => {
    row.style.display = (mode === 'all' || row.dataset.mode === mode) ? '' : 'none';
  });
  document.querySelectorAll('.filter-btn').forEach(btn => {
    const active = btn.dataset.mode === mode;
    btn.className = btn.className
      .replace(/bg-gray-700 text-gray-100|bg-gray-800 text-gray-500/g, '')
      .trim();
    btn.className += active ? ' bg-gray-700 text-gray-100' : ' bg-gray-800 text-gray-500';
  });
}
</script>
{% endblock %}
